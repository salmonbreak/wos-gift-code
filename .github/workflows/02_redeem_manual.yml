name: Redeem WoS code (manual)

on:
  workflow_dispatch:
    inputs:
      giftcode:
        description: "Gift code to redeem"
        required: true
        type: string

jobs:
  redeem:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download registrations CSV
        env:
          SHEET_CSV_URL: ${{ secrets.SHEET_CSV_URL }}
        run: |
          if [ -z "$SHEET_CSV_URL" ]; then
            echo "Missing SHEET_CSV_URL secret"; exit 1
          fi
          curl -L "$SHEET_CSV_URL" -o registrations.csv

      - name: Build player.json from CSV (column 'Player ID')
        run: |
          python - <<'PY'
          import csv, json, re

          PID_COL = "Player ID"

          ids = []
          with open("registrations.csv", newline="", encoding="utf-8") as f:
              reader = csv.DictReader(f)
              if not reader.fieldnames or PID_COL not in reader.fieldnames:
                  raise SystemExit(f"Could not find column '{PID_COL}'. Found: {reader.fieldnames}")
              for row in reader:
                  raw = (row.get(PID_COL) or "").strip()
                  raw = re.sub(r"\D+", "", raw)
                  if raw:
                      ids.append(raw)

          seen = set()
          unique = []
          for x in ids:
              if x not in seen:
                  seen.add(x)
                  unique.append(x)

          players = [{"fid": pid} for pid in unique]
          with open("player.json", "w", encoding="utf-8") as f:
              json.dump(players, f, indent=2)

          print(f"Players loaded: {len(players)}")
          PY

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Redeem code
        run: |
          echo "Redeeming code: ${{ inputs.giftcode }}"
          python redeem_code.py -c "${{ inputs.giftcode }}"

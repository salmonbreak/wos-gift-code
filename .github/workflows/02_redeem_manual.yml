name: Redeem WoS code (manual)

on:
  workflow_dispatch:
    inputs:
      giftcode:
        description: "Gift code to redeem"
        required: true
        type: string

jobs:
  redeem:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download registrations CSV
        env:
          SHEET_CSV_URL: ${{ secrets.SHEET_CSV_URL }}
        run: |
          if [ -z "$SHEET_CSV_URL" ]; then
            echo "Missing SHEET_CSV_URL secret"; exit 1
          fi
          curl -L "$SHEET_CSV_URL" -o registrations.csv

      - name: Build player.json from CSV (needs id, fid, original_name)
        run: |
          python - <<'PY'
          import csv, json, re

          PID_COL = "Player ID"
          NAME_COL = "In-game name"

          rows = []
          with open("registrations.csv", newline="", encoding="utf-8") as f:
              reader = csv.DictReader(f)
              if not reader.fieldnames or PID_COL not in reader.fieldnames:
                  raise SystemExit(f"Could not find column '{PID_COL}'. Found: {reader.fieldnames}")

              for row in reader:
                  pid_raw = (row.get(PID_COL) or "").strip()
                  pid = re.sub(r"\D+", "", pid_raw)  # digits only
                  if not pid:
                      continue

                  name = (row.get(NAME_COL) or "").strip()
                  if not name:
                      name = f"player_{pid}"

                  rows.append((pid, name))

          # de-dup by pid, keep first name seen
          seen = set()
          players = []
          for pid, name in rows:
              if pid in seen:
                  continue
              seen.add(pid)
              players.append({
                  "id": pid,              # required by redeem_code.py
                  "fid": pid,             # used elsewhere / backwards compat
                  "original_name": name   # required by redeem_code.py
              })

          with open("player.json", "w", encoding="utf-8") as f:
              json.dump(players, f, indent=2, ensure_ascii=False)

          print(f"Players loaded: {len(players)}")
          if players:
              print("Example entry:", players[0])
          PY
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Redeem code
        run: |
          echo "Redeeming code: ${{ inputs.giftcode }}"
          python redeem_code.py -c "${{ inputs.giftcode }}"
